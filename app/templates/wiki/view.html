{% extends "wiki/base.html" %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

{{ moment.include_moment() }}

{% if entry.content or (entry.dm_content and current_user.has_admin_role()) %}
<script type="text/javascript">
    options = {
        sanitize: true
    }

    {% if entry.content %}
    var content = document.getElementById('content')
    content.innerHTML = marked(content.innerHTML, options);
    {% endif %}

    {% if entry.dm_content and current_user.has_admin_role() %}
    var dm_content = document.getElementById('entry_dm_content')
    dm_content.innerHTML = marked(dm_content.innerHTML, options);
    {% endif %}
</script>
{% endif %}
{% endblock %}

{% block app_content %}
{{ super() }}

<ul class="nav nav-tabs">
    <li>
        <a href="{{ url_for('wiki.create') }}">
            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
            New article
        </a>
    </li>
    <li>
        <a href="{{ url_for('wiki.edit', id=entry.id) }}">
            <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
            Edit article
        </a>
    </li>

    {% if current_user.is_wiki_admin() %}
    <li>
        <a href="{{ url_for('wiki.toggle_vis', id=entry.id) }}">
            {% if entry.is_visible %}
            <span class="glyphicon glyphicon-eye-close" aria-hidden="true"></span>
            Hide article
            {% else %}
            <span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span>
            Make public
            {% endif %}
        </a>
    </li>
    {% endif %}
</ul>

{% if not entry.is_visible %}
<p class="alert alert-warning invis-warn">
    {% if not current_user.is_wiki_admin() %}
    This page is currently only visible to (wiki) admins and you.
    {% else %}
    This page is currently only visible to (wiki) admins.
    {% endif %}
</p>
{% endif %}

<h1>{{ entry.title }} </h1>

{% if entry.content %}
    {% if current_user.phb_wiki %}
    <div id="content" class="custom-markdown phb-style">
    {% else %}
    <div id="content" class="custom-markdown">
    {% endif %}
{{ entry.content }}
    </div>
{% else %}
<p>No content.</p>
{% endif %}

{% if map_nodes %}
<h2>Associated map nodes</h2>
<ul class="list-unstyled">
{% for node in map_nodes %}
<li><a href="{{ url_for('map.index_with_node', n_id=node.id) }}">{{ node.name }}</a></li>
{% endfor %}
</ul>
{% endif %}

{% if current_user.has_admin_role() %}
    {% if entry.dm_content %}
    <hr>
    <h2>DM Notes</h2>
    <p id="entry_dm_content" class="custom-markdown">
{{ entry.dm_content }}
    </p>
    {% endif %}
{% endif %}

{% if entry.tags %}
    {% for tag in entry.split_tags() %}
    <a href="{{ url_for('wiki.search_tag', tag=tag) }}">#{{ tag }}</a>
    {% endfor %}
{% endif %}
<hr>
<ul class="list-unstyled">
    <li>Created by <a href="{{ url_for('user.profile', username=entry.created_by.username) }}">{{ entry.created_by.username }}</a> ({{ moment(entry.created).format(current_user.dateformat) }})</li>
    {% if entry.edited_by %}
    <li>Edited by <a href="{{ url_for('user.profile', username=entry.edited_by.username) }}">{{ entry.edited_by.username }}</a> ({{ moment(entry.edited).format(current_user.dateformat) }})</li>
    {% endif %}
</ul>
{% endblock %}